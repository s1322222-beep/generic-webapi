<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Fortune Canvas</title>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <style>
    body{margin:0;font-family:system-ui;background:#111;color:#eee}
    header{padding:12px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{padding:10px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#eee;min-width:220px}
    button{padding:10px 14px;border-radius:10px;border:0;background:#eee;color:#111;font-weight:700}
    #fortune{padding:0 16px 12px;opacity:.95}
    small{padding:0 16px;display:block;opacity:.7}
    canvas{display:block;margin:0 auto;border-top:1px solid #222}
  </style>
</head>
<body>
  <header>
    <input id="msg" placeholder="ä¸€è¨€ï¼ˆä¾‹ï¼šæ‹ã€ãƒã‚¤ãƒˆã€ãƒ†ã‚¹ãƒˆï¼‰" />
    <button id="go">å ã†</button>
  </header>
  <div id="fortune">ğŸ”® ã“ã“ã«é‹å‹¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
  <small>â€»å…¥åŠ›ã—ãŸè¨€è‘‰ã‹ã‚‰AIãŒé‹å‹¢ãƒ‡ãƒ¼ã‚¿(JSON)ã‚’ç”Ÿæˆã—ã€è‰²ã¨å½¢ã§å¯è¦–åŒ–ã—ã¾ã™ã€‚</small>

  <script>
    const socket = io();

    // åˆæœŸå€¤ï¼ˆã‚µãƒ¼ãƒã‹ã‚‰è¿”ã£ã¦ããŸJSONã§ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
    let fortuneData = { fortune:"", luck:0.5, color:"#ffffff", shape:"circle", mood:"calm" };

    // é€ä¿¡ï¼ˆâ€»ã‚¤ãƒ™ãƒ³ãƒˆåãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆã‚ã›ã‚‹ï¼‰
    document.getElementById("go").onclick = () => {
      const text = document.getElementById("msg").value.trim();
      if(!text) return;
      socket.emit("ask", { text });
      document.getElementById("fortune").textContent = "ğŸ”® å ã„ä¸­â€¦";
    };

    // å—ä¿¡ï¼ˆâ€»ã‚¤ãƒ™ãƒ³ãƒˆåãŒé•ã†å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆã‚ã›ã‚‹ï¼‰
    socket.on("answer", (res) => {
      try{
        const obj = (typeof res === "string") ? JSON.parse(res) : res;
        fortuneData = obj;
        document.getElementById("fortune").textContent =
          `ğŸ”® ${obj.fortune}ï¼ˆé‹å‹¢:${Math.round(obj.luck*100)}%ï¼‰`;
      }catch(e){
        document.getElementById("fortune").textContent = "âš ï¸ JSONè§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
      }
    });

    function setup(){ createCanvas(window.innerWidth, 420); }
    function windowResized(){ resizeCanvas(window.innerWidth, 420); }

    function draw(){
      background(12);

      const cx = width/2, cy = height/2;
      const luck = Math.max(0, Math.min(1, Number(fortuneData.luck ?? 0.5)));
      const s = 120 + luck * 200;

      if(fortuneData.shape === "wave"){
        // wave
        noFill();
        stroke(fortuneData.color || "#fff");
        strokeWeight(6);
        beginShape();
        for(let x=0;x<=width;x+=18){
          const amp = 24 + luck * 70;
          const y = cy + Math.sin((x/70)+frameCount/25) * amp;
          vertex(x,y);
        }
        endShape();
      }else{
        // circle / square
        noStroke();
        fill(fortuneData.color || "#fff");
        if(fortuneData.shape === "square"){
          rectMode(CENTER);
          rect(cx, cy, s, s, 26);
        }else{
          ellipse(cx, cy, s, s);
        }
      }

      // ç”»é¢ä¸‹ã«ãƒ ãƒ¼ãƒ‰è¡¨ç¤ºï¼ˆåœ°å‘³ã«ä½œå“æ„Ÿä¸ŠãŒã‚‹ï¼‰
      noStroke();
      fill(220);
      textAlign(CENTER);
      textSize(14);
      const mood = fortuneData.mood ? String(fortuneData.mood) : "calm";
      text(`mood: ${mood}`, width/2, height-18);
    }
  </script>
</body>
</html>
