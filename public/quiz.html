<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Fortune Canvas</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.9.0/lib/p5.min.js"></script>
  <style>
    body{margin:0;background:#111;color:#fff;font-family:system-ui}
    header{padding:10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input{padding:10px;border-radius:10px;border:1px solid #333;background:#1b1b1b;color:#eee;min-width:220px}
    button{padding:10px 14px;border-radius:10px;border:0;background:#eee;color:#111;font-weight:700}
    #fortune{padding:0 10px 6px;opacity:.95}
    #debug{padding:0 10px 10px;opacity:.8;font-size:13px}
    small{padding:0 10px 10px;display:block;opacity:.7}
    canvas{display:block;margin:0 auto;border-top:1px solid #222}
  </style>
</head>
<body>
  <header>
    <input id="msg" placeholder="ä¸€è¨€ï¼ˆä¾‹ï¼šæ‹ãƒ»ãƒã‚¤ãƒˆãƒ»ãƒ†ã‚¹ãƒˆï¼‰">
    <button id="go">å ã†</button>
  </header>

  <div id="fortune">ğŸ”® ã“ã“ã«é‹å‹¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>
  <div id="debug">color: - / shape: - / mood: - / luck: -</div>
  <small>LLMãŒç”Ÿæˆã—ãŸJSONï¼ˆluck/color/shape/moodï¼‰ã‚’p5.jsã§å¯è¦–åŒ–ã—ã¾ã™ã€‚</small>

<script>
  
  const PALETTE = ["#FF7A00","#4DA3FF","#B84DFF","#00E5A8","#FF4D6D","#FFD166","#06D6A0","#118AB2"];

  let data = { fortune:"", luck:0.5, color:"#4DA3FF", shape:"circle", mood:"calm" };

  document.getElementById("go").onclick = send;

  function clamp01(x){
    const n = Number(x);
    return Number.isFinite(n) ? Math.max(0, Math.min(1, n)) : 0.5;
  }

  function pickFallback(seedText){

    let h = 0;
    for (let i=0;i<seedText.length;i++) h = (h*31 + seedText.charCodeAt(i)) >>> 0;
    return PALETTE[h % PALETTE.length];
  }

  function normalize(raw, seedText){
    const obj = raw && typeof raw === "object" ? raw : {};

    // fortune
    const fortune = (obj.fortune ?? obj.message ?? obj.text ?? "ä»Šæ—¥ã¯è½ã¡ç€ã„ã¦é€²ã‚ã‚‹ã¨è‰¯ã„æ—¥").toString();

    // luck 0..1
    const luck = clamp01(obj.luck ?? obj.score ?? obj.rate ?? 0.5);

    let color = (obj.color ?? obj.colour ?? "").toString().trim();
    const isHex = /^#[0-9a-fA-F]{6}$/.test(color);
    if (!isHex || !PALETTE.includes(color)) color = pickFallback(seedText);

    
    let shape = (obj.shape ?? "circle").toString().trim();
    if (!["circle","square","wave"].includes(shape)) {

      shape = (seedText.length % 3 === 0) ? "wave" : (seedText.length % 3 === 1) ? "square" : "circle";
    }

    
    let mood = (obj.mood ?? "calm").toString().trim();
    if (!["warm","calm","dark","bright"].includes(mood)) mood = "calm";

    return { fortune, luck, color, shape, mood };
  }

  function send(){
    const text = document.getElementById("msg").value.trim();
    if(!text) return;

    document.getElementById("fortune").innerText = "ğŸ”® å ã„ä¸­â€¦";

    fetch("/api/",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ prompt: text })
    })
    .then(r=>r.json())
    .then(j=>{
      const raw = j.data || j;

      data = normalize(raw, text);

      document.getElementById("fortune").innerText =
        "ğŸ”® " + data.fortune + "ï¼ˆé‹å‹¢:" + Math.round(data.luck*100) + "%ï¼‰";

      document.getElementById("debug").innerText =
        `color: ${data.color} / shape: ${data.shape} / mood: ${data.mood} / luck: ${Math.round(data.luck*100)}%`;
    })
    .catch(()=>{
      document.getElementById("fortune").innerText = "âš ï¸ APIé€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸ";
    });
  }


  function setup(){ createCanvas(window.innerWidth, 420); }
  function windowResized(){ resizeCanvas(window.innerWidth, 420); }

  function draw(){
    background(12);

    const cx = width/2, cy = height/2;
    const s = 120 + data.luck * 200;

    if(data.shape === "wave"){
      noFill();
      stroke(data.color);
      strokeWeight(6);
      beginShape();
      for(let x=0;x<=width;x+=18){
        const amp = 24 + data.luck * 70;
        const y = cy + Math.sin((x/70)+frameCount/25) * amp;
        vertex(x,y);
      }
      endShape();
    }else{
      noStroke();
      fill(data.color);
      if(data.shape === "square"){
        rectMode(CENTER);
        rect(cx, cy, s, s, 26);
      }else{
        ellipse(cx, cy, s, s);
      }
    }

    noStroke();
    fill(220);
    textAlign(CENTER);
    textSize(14);
    text(`mood: ${data.mood}`, width/2, height-18);
  }
</script>
</body>
</html>
